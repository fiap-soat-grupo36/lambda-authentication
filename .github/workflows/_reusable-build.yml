name: _reusable-build
on:
  workflow_call:
    inputs:
        python_version:
            required: false
            type: string
            default: '3.12'
        
jobs:
    build-python:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: './app/'
        steps:
          - name: Checkout
            uses: actions/checkout@v3

          - name: Install dependencies
            run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt || true
                pip install pytest pytest-cov flake8

          - name: Lint with Flake8
            run: |
                flake8 . || true

          - name: Run tests
            run: |
              # ensure the repository root is on PYTHONPATH so `import app.handler` works
              PYTHONPATH=.. pytest -q ./tests --cov=./ --cov-report=xml:coverage.xml --cov-report=html

          - name: Upload coverage artifact
            uses: actions/upload-artifact@v4
            with:
              name: coverage-report
              path: |
                app/coverage.xml
                app/htmlcov