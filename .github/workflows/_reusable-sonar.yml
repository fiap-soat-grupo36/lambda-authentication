name: _reusable-sonar
on:
  workflow_call:
    inputs:
      java_version:
        required: false
        type: string
        default: '17'
      sonar_host:
        required: false
        type: string
        default: 'https://sonarcloud.io'
      sonar_org:
        required: true
        type: string
      sonar_project_key:
        required: true
        type: string
      language:
        required: false
        type: string
        default: 'python'
      python_version:
        required: false
        type: string
        default: '3.12'
      requirements_path:
        required: false
        type: string
        default: 'requirements.txt'
      test_command:
        required: false
        type: string
        default: ''
      coverage_report:
        required: false
        type: string
        default: 'coverage.xml'
      scanner_version:
        required: false
        type: string
        default: '4.8.1.3023'
      maven_args:
        required: false
        type: string
        default: ''
    secrets:
      SONAR_TOKEN:
        required: false

jobs:
  sonar:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK (required by SonarScanner)
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version }}
          distribution: temurin

      - name: "Python path: setup and tests"
        if: ${{ inputs.language == 'python' }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install Python dependencies and run tests
        if: ${{ inputs.language == 'python' }}
        env:
          PYTHONUNBUFFERED: 1
        run: |
          # install test deps
          if [ -f "${{ inputs.requirements_path }}" ]; then
            python -m pip install --upgrade pip
            pip install -r "${{ inputs.requirements_path }}"
          else
            python -m pip install --upgrade pip
          fi
          # install test tools if not present
          pip install pytest pytest-cov || true
          # run tests if a command was provided, otherwise try default discovery
          if [ -n "${{ inputs.test_command }}" ]; then
            eval "${{ inputs.test_command }}"
          else
            # run pytest and generate coverage xml at the configured path
            pytest --cov=./ --cov-report=xml:${{ inputs.coverage_report }} || true
          fi

      - name: Build (Maven) and Sonar (Java projects)
        if: ${{ inputs.language == 'maven' }}
        run: |
          mvn --batch-mode clean compile test-compile ${{ inputs.maven_args }}

      - name: Run SonarScanner CLI
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          set -euo pipefail
          SCANNER_VER=${{ inputs.scanner_version }}
          SCANNER_ZIP=sonar-scanner-cli-${SCANNER_VER}-linux.zip
          SCANNER_URL="https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/${SCANNER_ZIP}"
          echo "Attempting to download SonarScanner ${SCANNER_VER} from ${SCANNER_URL}"

          # Try download; if not found or not a valid zip, try fallback versions
          try_download() {
            ver="$1"
            zip="sonar-scanner-cli-${ver}-linux.zip"
            url="https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/${zip}"
            echo "Downloading ${zip} from ${url}"
            curl -fSL -o "/tmp/${zip}" "${url}" || return 1
            # quick sanity check: verify it's a zip by checking the file signature
            if unzip -t "/tmp/${zip}" >/dev/null 2>&1; then
              SCANNER_VER="${ver}"
              SCANNER_ZIP="${zip}"
              return 0
            else
              echo "Downloaded file /tmp/${zip} is not a valid zip archive"
              return 2
            fi
          }

          if ! try_download "${SCANNER_VER}"; then
            echo "Primary download failed for version ${SCANNER_VER}, trying fallbacks..."
            for v in 4.8.1.3023 4.7.0.2747 4.6.2.2472; do
              if try_download "${v}"; then
                echo "Using fallback SonarScanner version ${v}"
                break
              fi
            done
          fi

          # unzip and locate extracted directory (handles different archive root names)
          unzip -q /tmp/${SCANNER_ZIP} -d /tmp
          SCANNER_DIR=$(find /tmp -maxdepth 1 -type d -name "sonar-scanner*" | head -n1 || true)
          if [ -z "${SCANNER_DIR}" ]; then
            echo "Could not find extracted sonar-scanner directory under /tmp" >&2
            ls -la /tmp
            exit 2
          fi
          echo "Found scanner dir: ${SCANNER_DIR}"
          # ensure the scanner bin is executable
          chmod -R +x "${SCANNER_DIR}/bin" || true
          export PATH="${SCANNER_DIR}/bin:$PATH"
          echo "Running sonar-scanner from ${SCANNER_DIR}/bin"

          # prepare sonar properties
          sonar_args=(
            -Dsonar.host.url="${{ inputs.sonar_host }}"
            -Dsonar.organization="${{ inputs.sonar_org }}"
            -Dsonar.projectKey="${{ inputs.sonar_project_key }}"
            -Dsonar.login="${SONAR_TOKEN}"
          )
          if [ "${{ inputs.language }}" = "python" ]; then
            sonar_args+=(
              -Dsonar.python.version="${{ inputs.python_version }}"
              -Dsonar.python.coverage.reportPaths="${{ inputs.coverage_report }}"
              -Dsonar.sources=app,src
            )
          fi

          # invoke the scanner directly from the extracted bin folder
          "${SCANNER_DIR}/bin/sonar-scanner" "${sonar_args[@]}"